---
name: "Check for No CI/CD Run"
on:
  workflow_call:
    outputs:
      continue:
        description: "Flag to indicate if CI/CD should run"
        value: ${{ jobs.check.outputs.continue }}
jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    outputs:
      continue: ${{ steps.result.outputs.continue }}
    steps:
      - name: Test for no_ci_cd_run label
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # pin@v6
        id: label
        with:
          result-encoding: string
          script: |
            var issue_number = undefined;
            if ('pull_request' in context.payload) {
              console.log("INFO: pull request detected")
              issue_number = context.payload.pull_request.number
              console.log("INFO: issue number: " + issue_number)
            } else {
              console.log("INFO: pull request not detected")
              var ref = context.ref
              console.log("INFO: ref: " + ref)
              const { data: issues } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: ref
              })
              issue_number = issues.map(issue => issue.number)[0]
              console.log("INFO: issue number: " + issue_number)
            }
            if (issue_number) {
              console.log("INFO: looking up labels on issue")
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number
              })
              return !issue.labels.map(label => label.name).includes("no_ci_cd_run")
            } else {
              console.log("INFO: using default value as no issue")
              return true
            }

      - name: Output summary
        run: |
          echo "**Check for No CI/CD Run**" >> $GITHUB_STEP_SUMMARY
          echo "Continue: ${{ steps.label.outputs.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Output result
        id: result
        run: echo "continue=${{ steps.label.outputs.result }}" >> $GITHUB_OUTPUT
